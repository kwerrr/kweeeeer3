import asyncio
import logging
import secrets
from datetime import datetime
from typing import Optional, Dict, List
from enum import Enum

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command, CommandStart, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.utils.markdown import hbold, hcode
import configparser

# –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
config = configparser.ConfigParser()
config.read('config.ini')

BOT_TOKEN = '8257496038:AAF51rV91ks99RaXUi33V7zEo4Ps9hXUHPQ'
ADMIN_IDS = '2023413492'
SUPPORT_USERNAME = 'supporOTC'
WEBSITE_URL = 'https://playerok.com'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
SUPPORTED_CURRENCIES = {
    'STARS': '‚≠ê STARS',
    'TON': 'üíé TON',
    'RUB': 'üá∑üá∫ RUB',
    'KZT': 'üá∞üáø KZT',
    'BYN': 'üáßüáæ BYN',
    'UAH': 'üá∫üá¶ UAH'
}

class DealStatus(Enum):
    PENDING = 'pending'
    PAID = 'paid'
    NFT_SENT = 'nft_sent'
    COMPLETED = 'completed'
    DISPUTE = 'dispute'
    CANCELLED = 'cancelled'

class UserRole(Enum):
    USER = 'user'
    ADMIN = 'admin'

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class DealCreation(StatesGroup):
    checking_requisites = State()
    choosing_currency = State()
    entering_amount = State()
    entering_description = State()
    confirming = State()

class RequisitesManagement(StatesGroup):
    choosing_type = State()
    entering_card = State()
    entering_phone = State()
    entering_stars = State()
    entering_ton_wallet = State()
    confirming = State()

class AdminActions(StatesGroup):
    adding_balance = State()
    adding_successful_deals = State()
    sending_broadcast = State()
    managing_deal = State()

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PostgreSQL/MySQL)
class Database:
    def __init__(self):
        self.users: Dict[int, dict] = {}
        self.deals: Dict[str, dict] = {}
        
    def get_user(self, user_id: int) -> dict:
        if user_id not in self.users:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
            role = UserRole.ADMIN.value if str(user_id) in ADMIN_IDS else UserRole.USER.value
            self.users[user_id] = {
                'user_id': user_id,
                'username': None,
                'first_name': None,
                'role': role,
                'balance': 0,
                'total_turnover': 0,
                'successful_deals': 0,
                'created_at': datetime.now().isoformat(),
                'deals': [],
                'requisites': {
                    'card': None,
                    'phone': None,
                    'stars': None,
                    'ton_wallet': None
                },
                'has_requisites': False
            }
        return self.users[user_id]
    
    def update_user(self, user_id: int, **kwargs):
        if user_id in self.users:
            self.users[user_id].update(kwargs)
    
    def add_requisite(self, user_id: int, type: str, value: str):
        if user_id in self.users:
            self.users[user_id]['requisites'][type] = value
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ–∫–≤–∏–∑–∏—Ç
            req = self.users[user_id]['requisites']
            self.users[user_id]['has_requisites'] = bool(req['card'] or req['phone'] or req['stars'] or req['ton_wallet'])
    
    def get_requisites(self, user_id: int) -> dict:
        return self.users.get(user_id, {}).get('requisites', {'card': None, 'phone': None, 'stars': None, 'ton_wallet': None})
    
    def create_deal(self, creator_id: int, currency: str, amount: float, description: str) -> str:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å —Å–∏–º–≤–æ–ª–æ–º #
        while True:
            random_part = secrets.token_hex(4).upper()
            deal_id = f"#{random_part}"
            if deal_id not in self.deals:
                break
        
        self.deals[deal_id] = {
            'deal_id': deal_id,
            'creator_id': creator_id,
            'buyer_id': None,
            'currency': currency,
            'amount': amount,
            'description': description,
            'status': DealStatus.PENDING.value,
            'created_at': datetime.now().isoformat(),
            'paid_at': None,
            'completed_at': None,
            'nft_proof': None,
            'gift_sent_at': None
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.users[creator_id]['deals'].append(deal_id)
        
        return deal_id
    
    def get_deal(self, deal_id: str) -> Optional[dict]:
        return self.deals.get(deal_id)
    
    def update_deal(self, deal_id: str, **kwargs):
        if deal_id in self.deals:
            self.deals[deal_id].update(kwargs)
    
    def get_user_deals(self, user_id: int) -> List[dict]:
        user_deals = []
        for deal_id, deal in self.deals.items():
            if deal['creator_id'] == user_id or deal.get('buyer_id') == user_id:
                user_deals.append(deal)
        return user_deals
    
    def get_all_deals(self) -> List[dict]:
        return list(self.deals.values())
    
    def get_pending_deals(self) -> List[dict]:
        return [d for d in self.deals.values() if d['status'] == DealStatus.PENDING.value]
    
    def get_active_deals(self) -> List[dict]:
        active_statuses = [DealStatus.PENDING.value, DealStatus.PAID.value, DealStatus.NFT_SENT.value]
        return [d for d in self.deals.values() if d['status'] in active_statuses]

db = Database()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_main_keyboard(user_id: int) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="üõ° –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É", callback_data="create_deal")
    builder.button(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="show_profile")
    builder.button(text="üí≥ –ú–æ–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã", callback_data="manage_requisites")
    builder.button(text="üåê –ù–∞—à —Å–∞–π—Ç", url=WEBSITE_URL)
    builder.button(text="üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url=f"https://t.me/{SUPPORT_USERNAME}")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    user = db.get_user(user_id)
    if user['role'] == UserRole.ADMIN.value:
        builder.button(text="üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å", callback_data="admin_panel")
    
    builder.adjust(1)
    return builder.as_markup()

def get_requisites_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="üí≥ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É", callback_data="add_card")
    builder.button(text="üì± –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω (–°–ë–ü)", callback_data="add_phone")
    builder.button(text="‚≠ê –î–æ–±–∞–≤–∏—Ç—å STARS (username)", callback_data="add_stars")
    builder.button(text="üíé –î–æ–±–∞–≤–∏—Ç—å TON –∫–æ—à–µ–ª–µ–∫", callback_data="add_ton_wallet")
    builder.button(text="üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã", callback_data="show_requisites")
    builder.button(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_currencies_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    for code, name in SUPPORTED_CURRENCIES.items():
        builder.button(text=name, callback_data=f"currency_{code}")
    builder.button(text="üîô –û—Ç–º–µ–Ω–∞", callback_data="cancel")
    builder.adjust(2)
    return builder.as_markup()

def get_deal_actions_keyboard(deal_id: str, user_role: str = UserRole.USER.value, user_id: int = None) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    deal = db.get_deal(deal_id)
    
    if deal['status'] == DealStatus.PENDING.value:
        builder.button(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", callback_data=f"pay_{deal_id}")
        builder.button(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_{deal_id}")
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞ "–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω" –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
    if deal['status'] == DealStatus.PAID.value and user_id == deal['creator_id']:
        builder.button(text="üéÅ –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", callback_data=f"gift_sent_{deal_id}")
    
    if user_role == UserRole.ADMIN.value:
        if deal['status'] == DealStatus.NFT_SENT.value:
            builder.button(text="‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É", callback_data=f"admin_complete_{deal_id}")
        elif deal['status'] == DealStatus.DISPUTE.value:
            builder.button(text="‚öñÔ∏è –†–µ—à–∏—Ç—å —Å–ø–æ—Ä", callback_data=f"admin_resolve_{deal_id}")
    
    builder.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"refresh_{deal_id}")
    builder.adjust(2)
    return builder.as_markup()

def get_admin_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")
    builder.button(text="üíº –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏", callback_data="admin_deals")
    builder.button(text="üí∞ –ù–∞–∫—Ä—É—Ç–∏—Ç—å –æ–±–æ—Ä–æ—Ç—ã", callback_data="admin_add_turnover")
    builder.button(text="‚úÖ –ù–∞–∫—Ä—É—Ç–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–µ —Å–¥–µ–ª–∫–∏", callback_data="admin_add_success")
    builder.button(text="üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="admin_broadcast")
    builder.button(text="üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="admin_users")
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")
    builder.adjust(2)
    return builder.as_markup()

def get_back_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")
    return builder.as_markup()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
@dp.message(CommandStart())
async def cmd_start(message: types.Message, command: CommandStart):
    user_id = message.from_user.id
    user = db.get_user(user_id)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    db.update_user(user_id, 
                   username=message.from_user.username,
                   first_name=message.from_user.first_name)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ—à–ª–∏ –ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º deal_...
    args = command.args
    if args and args.startswith("deal_"):
        clean_deal_id = args[5:].upper()
        deal_id = f"#{clean_deal_id}"
        deal = db.get_deal(deal_id)
        
        if not deal:
            await message.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
            
        if deal['status'] != DealStatus.PENDING.value:
            await message.answer("‚ùå –≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã")
            return
            
        if deal['creator_id'] == user_id:
            await message.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–¥–µ–ª–∫—É")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥–∞–≤—Ü–µ
        seller = db.get_user(deal['creator_id'])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü—É –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        try:
            buyer_info = f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {message.from_user.first_name}"
            if message.from_user.username:
                buyer_info += f" (@{message.from_user.username})"
            
            await bot.send_message(
                deal['creator_id'],
                f"{hbold('üëã –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —Å–¥–µ–ª–∫–µ!')}\n\n"
                f"{buyer_info}\n"
                f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n\n"
                f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:\n"
                f"‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {user['successful_deals']}\n"
                f"üí∞ –û–±–æ—Ä–æ—Ç: {user['total_turnover']} RUB",
                parse_mode="HTML"
            )
        except Exception as e:
            logging.error(f"Failed to notify seller: {e}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ
        kb = InlineKeyboardMarkup(inline_keyboard=[[
            InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", callback_data=f"pay")
        ]])
        
        await message.answer(
            f"–í—ã —Ö–æ—Ç–∏—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–¥–µ–ª–∫—É:\n\n"
            f"ID: {deal_id}\n"
            f"üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: {seller['first_name']} (@{seller['username']})\n"
            f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞:\n"
            f"‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {seller['successful_deals']}\n"
            f"üí∞ –û–±–æ—Ä–æ—Ç: {seller['total_turnover']} RUB\n\n"
            f"–°—É–º–º–∞: {deal['amount']} {SUPPORTED_CURRENCIES[deal['currency']]}\n"
            f"–û–ø–∏—Å–∞–Ω–∏–µ: {deal['description']}\n\n"
            f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û–ø–ª–∞—Ç–∏—Ç—å', —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.",
            reply_markup=kb
        )
        return
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    welcome_text = (
        f"{hbold('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Playerok!')}\n\n"
        f"–°–µ—Ä–≤–∏—Å, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —É–¥–æ–±—Å—Ç–≤–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫.\n\n"
        f"üì¢ –ù–∞—à –∫–∞–Ω–∞–ª ‚Äî @playerok_com\n"
        f"üõü –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî @supporOTC\n\n"
        f"üëá –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
    )
    
    kb = InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text="‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data="continue_to_main")
    ]])
    
    await message.answer(welcome_text, reply_markup=kb, parse_mode="HTML")

# –°–∫—Ä—ã—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–ø–ª–∞—Ç—ã —Å–¥–µ–ª–∫–∏ (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
@dp.message(Command("fastbuy"))
async def fast_buy(message: types.Message):
    # –ü–æ–ª—É—á–∞–µ–º ID —Å–¥–µ–ª–∫–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã
    command_parts = message.text.split()
    
    if len(command_parts) != 2:
        await message.answer(
            "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
        )
        return
    
    deal_id_input = command_parts[1].upper()
    
    # –î–æ–±–∞–≤–ª—è–µ–º # –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not deal_id_input.startswith('#'):
        deal_id = f"#{deal_id_input}"
    else:
        deal_id = deal_id_input
    
    deal = db.get_deal(deal_id)
    user_id = message.from_user.id
    user = db.get_user(user_id)
    
    if not deal:
        await message.answer("‚ùå –°–¥–µ–ª–∫–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    if deal['status'] != DealStatus.PENDING.value:
        await message.answer("‚ùå –≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã")
        return
    
    if deal['creator_id'] == user_id:
        await message.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–¥–µ–ª–∫—É")
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É
    db.update_deal(deal_id,
                   buyer_id=user_id,
                   status=DealStatus.PAID.value,
                   paid_at=datetime.now().isoformat())
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ
    buyer = db.get_user(user_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω" –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller_keyboard = InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text="üéÅ –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", callback_data=f"gift_sent_{deal_id}")
    ]])
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller_id = deal['creator_id']
    try:
        seller_notification = (
            f"{hbold('üí∞ –ü–æ–ª—É—á–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞ –ø–æ —Å–¥–µ–ª–∫–µ!')}\n\n"
            f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n"
            f"–°—É–º–º–∞: {deal['amount']} {SUPPORTED_CURRENCIES[deal['currency']]}\n\n"
            f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ:\n"
            f"üë§ –ò–º—è: {buyer['first_name']}\n"
            f"üìä –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {buyer['successful_deals']}\n"
            f"üí∞ –û–±–æ—Ä–æ—Ç: {buyer['total_turnover']} RUB\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ NFT –ø–æ–¥–¥–µ—Ä–∂–∫–µ @supporOTC\n"
            f"–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
        )
        await bot.send_message(
            seller_id, 
            seller_notification, 
            reply_markup=seller_keyboard,
            parse_mode="HTML"
        )
    except Exception as e:
        logging.error(f"Failed to notify seller: {e}")
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
    await message.answer(
        f"{hbold('‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!')}\n\n"
        f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n"
        f"–°—É–º–º–∞: {deal['amount']} {SUPPORTED_CURRENCIES[deal['currency']]}\n\n"
        f"–ü—Ä–æ–¥–∞–≤–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ, –ø–æ–∫–∞ –æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–¥–∞—Ä–æ–∫ –≥–∞—Ä–∞–Ω—Ç—É.\n"
        f"–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.",
        parse_mode="HTML"
    )

@dp.callback_query(lambda c: c.data == "continue_to_main")
async def continue_to_main(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    
    await callback.message.edit_text(
        f"{hbold('üõ° Playerok Bot | OTC')}\n\n"
        f"–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ —É–¥–æ–±–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–¥–µ–ª–æ–∫!\n\n"
        f"üîπ {hbold('–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:')}\n"
        f"1. –ü—Ä–æ–¥–∞–≤–µ—Ü —Å–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É\n"
        f"2. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —Å–¥–µ–ª–∫—É –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º\n"
        f"3. –ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç NFT –ø–æ–¥–¥–µ—Ä–∂–∫–µ\n"
        f"4. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–¥–µ–ª–∫—É\n\n"
        f"{hbold('üëá –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:')}",
        reply_markup=get_main_keyboard(user_id),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "back_to_main")
async def back_to_main(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    await callback.message.edit_text(
        f"{hbold('üõ° Playerok Bot | OTC')}\n\n"
        f"{hbold('üëá –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:')}",
        reply_markup=get_main_keyboard(user_id),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "manage_requisites")
async def manage_requisites(callback: types.CallbackQuery):
    await callback.message.edit_text(
        f"{hbold('üí≥ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏')}\n\n"
        f"–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã:\n"
        f"‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞\n"
        f"‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–°–ë–ü)\n"
        f"‚Ä¢ STARS (—é–∑–µ—Ä–Ω–µ–π–º)\n"
        f"‚Ä¢ TON –∫–æ—à–µ–ª–µ–∫\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_requisites_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "add_card")
async def add_card_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(RequisitesManagement.entering_card)
    await callback.message.edit_text(
        "üí≥ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã:\n"
        "(—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, 16-20 —Å–∏–º–≤–æ–ª–æ–≤)"
    )
    await callback.answer()

@dp.message(RequisitesManagement.entering_card)
async def process_card(message: types.Message, state: FSMContext):
    card = message.text.replace(' ', '').replace('-', '')
    
    if not card.isdigit() or len(card) < 16 or len(card) > 20:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–∞—Ä—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
        return
    
    user_id = message.from_user.id
    db.add_requisite(user_id, 'card', card)
    
    await state.clear()
    await message.answer("‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
    await show_requisites_menu(message)

@dp.callback_query(lambda c: c.data == "add_phone")
async def add_phone_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(RequisitesManagement.entering_phone)
    await callback.message.edit_text(
        "üì± –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –°–ë–ü:\n"
        "(–≤ —Ñ–æ—Ä–º–∞—Ç–µ 79991234567 –∏–ª–∏ +79991234567)"
    )
    await callback.answer()

@dp.message(RequisitesManagement.entering_phone)
async def process_phone(message: types.Message, state: FSMContext):
    phone = message.text.replace('+', '').replace(' ', '').replace('-', '')
    
    if not phone.isdigit() or len(phone) < 10 or len(phone) > 15:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
        return
    
    user_id = message.from_user.id
    db.add_requisite(user_id, 'phone', phone)
    
    await state.clear()
    await message.answer("‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
    await show_requisites_menu(message)

@dp.callback_query(lambda c: c.data == "add_stars")
async def add_stars_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(RequisitesManagement.entering_stars)
    await callback.message.edit_text(
        "‚≠ê –í–≤–µ–¥–∏—Ç–µ username –¥–ª—è STARS:\n"
        "(–Ω–∞–ø—Ä–∏–º–µ—Ä: @username –∏–ª–∏ username)"
    )
    await callback.answer()

@dp.message(RequisitesManagement.entering_stars)
async def process_stars(message: types.Message, state: FSMContext):
    stars = message.text.strip()
    
    # –£–±–∏—Ä–∞–µ–º @ –µ—Å–ª–∏ –µ—Å—Ç—å
    if stars.startswith('@'):
        stars = stars[1:]
    
    if len(stars) < 3 or len(stars) > 32:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç username. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
        return
    
    user_id = message.from_user.id
    db.add_requisite(user_id, 'stars', stars)
    
    await state.clear()
    await message.answer("‚úÖ STARS username —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
    await show_requisites_menu(message)

@dp.callback_query(lambda c: c.data == "add_ton_wallet")
async def add_ton_wallet_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(RequisitesManagement.entering_ton_wallet)
    await callback.message.edit_text(
        "üíé –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å TON –∫–æ—à–µ–ª—å–∫–∞:\n"
        "(—Ñ–æ—Ä–º–∞—Ç: UQ... –∏–ª–∏ EQ...)"
    )
    await callback.answer()

@dp.message(RequisitesManagement.entering_ton_wallet)
async def process_ton_wallet(message: types.Message, state: FSMContext):
    ton_wallet = message.text.strip()
    
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ TON –∫–æ—à–µ–ª—å–∫–∞
    if not (ton_wallet.startswith('UQ') or ton_wallet.startswith('EQ')) or len(ton_wallet) < 40:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç TON –∫–æ—à–µ–ª—å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
        return
    
    user_id = message.from_user.id
    db.add_requisite(user_id, 'ton_wallet', ton_wallet)
    
    await state.clear()
    await message.answer("‚úÖ TON –∫–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
    await show_requisites_menu(message)

@dp.callback_query(lambda c: c.data == "show_requisites")
async def show_requisites(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    req = db.get_requisites(user_id)
    
    text = f"{hbold('üí≥ –í–∞—à–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:')}\n\n"
    
    if req['card']:
        # –ú–∞—Å–∫–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
        masked_card = f"**** **** **** {req['card'][-4:]}"
        text += f"üí≥ –ö–∞—Ä—Ç–∞: {masked_card}\n"
    else:
        text += "üí≥ –ö–∞—Ä—Ç–∞: –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞\n"
    
    if req['phone']:
        text += f"üì± –¢–µ–ª–µ—Ñ–æ–Ω: +{req['phone']}\n"
    else:
        text += "üì± –¢–µ–ª–µ—Ñ–æ–Ω: –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω\n"
    
    if req['stars']:
        text += f"‚≠ê STARS: @{req['stars']}\n"
    else:
        text += "‚≠ê STARS: –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω\n"
    
    if req['ton_wallet']:
        # –ú–∞—Å–∫–∏—Ä—É–µ–º –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        masked_wallet = f"{req['ton_wallet'][:4]}...{req['ton_wallet'][-4:]}"
        text += f"üíé TON: {masked_wallet}\n"
    else:
        text += "üíé TON: –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω\n"
    
    await callback.message.edit_text(text, reply_markup=get_requisites_keyboard(), parse_mode="HTML")
    await callback.answer()

async def show_requisites_menu(message: types.Message):
    user_id = message.from_user.id
    await message.answer(
        f"{hbold('üí≥ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏')}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_requisites_keyboard(),
        parse_mode="HTML"
    )

@dp.callback_query(lambda c: c.data == "create_deal")
async def create_deal_start(callback: types.CallbackQuery, state: FSMContext):
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
    if not user['has_requisites']:
        await callback.message.edit_text(
            f"{hbold('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã!')}\n\n"
            f"–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ –≤–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã:\n"
            f"‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞\n"
            f"‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–°–ë–ü)\n"
            f"‚Ä¢ STARS (—é–∑–µ—Ä–Ω–µ–π–º)\n"
            f"‚Ä¢ TON –∫–æ—à–µ–ª–µ–∫\n\n"
            f"–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª '–ú–æ–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã' –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.",
            reply_markup=get_requisites_keyboard(),
            parse_mode="HTML"
        )
        await callback.answer()
        return
    
    await state.set_state(DealCreation.choosing_currency)
    await callback.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –¥–ª—è —Å–¥–µ–ª–∫–∏:",
        reply_markup=get_currencies_keyboard()
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "show_profile")
async def show_profile(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    user_deals = db.get_user_deals(user_id)
    
    active_deals = [d for d in user_deals if d['status'] in [DealStatus.PENDING.value, DealStatus.PAID.value, DealStatus.NFT_SENT.value]]
    completed_deals = [d for d in user_deals if d['status'] == DealStatus.COMPLETED.value]
    
    profile_text = (
        f"{hbold('üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å')}\n\n"
        f"ID: {user_id}\n"
        f"–ò–º—è: {user['first_name']}\n"
        f"Username: @{user['username'] if user['username'] else '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}\n"
        f"–†–æ–ª—å: {'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if user['role'] == 'admin' else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}\n\n"
        f"{hbold('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:')}\n"
        f"üí∞ –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {len(user_deals)}\n"
        f"üîÑ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {len(active_deals)}\n"
        f"‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {user['successful_deals']}\n"
        f"üìà –û–±–æ—Ä–æ—Ç: {user['total_turnover']} TON\n\n"
        f"{hbold('üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã:')}\n"
        f"–ö–∞—Ä—Ç–∞: {'‚úÖ' if user['requisites']['card'] else '‚ùå'}\n"
        f"–¢–µ–ª–µ—Ñ–æ–Ω: {'‚úÖ' if user['requisites']['phone'] else '‚ùå'}\n"
        f"STARS: {'‚úÖ' if user['requisites']['stars'] else '‚ùå'}\n"
        f"TON: {'‚úÖ' if user['requisites']['ton_wallet'] else '‚ùå'}\n"
    )
    
    if active_deals:
        profile_text += f"\n{hbold('üìã –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏:')}\n"
        for deal in active_deals[:5]:
            status_emoji = {
                DealStatus.PENDING.value: "‚è≥",
                DealStatus.PAID.value: "üí∞",
                DealStatus.NFT_SENT.value: "üéÅ"
            }.get(deal['status'], "‚ùì")
            profile_text += f"{status_emoji} {deal['deal_id']} - {deal['amount']} {deal['currency']}\n"
    
    await callback.message.edit_text(
        profile_text,
        reply_markup=get_back_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "admin_panel")
async def admin_panel(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    
    if user['role'] != UserRole.ADMIN.value:
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
        return
    
    await callback.message.edit_text(
        f"{hbold('üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å')}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_admin_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith('currency_'), StateFilter(DealCreation.choosing_currency))
async def process_currency(callback: types.CallbackQuery, state: FSMContext):
    currency = callback.data.replace('currency_', '')
    await state.update_data(currency=currency)
    await state.set_state(DealCreation.entering_amount)
    
    await callback.message.edit_text(
        f"–í—ã–±—Ä–∞–Ω–∞ –≤–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[currency]}\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å–¥–µ–ª–∫–∏:"
    )
    await callback.answer()

@dp.message(DealCreation.entering_amount)
async def process_amount(message: types.Message, state: FSMContext):
    try:
        amount = float(message.text.replace(',', '.'))
        if amount <= 0:
            raise ValueError
    except ValueError:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É")
        return
    
    await state.update_data(amount=amount)
    await state.set_state(DealCreation.entering_description)
    await message.answer("üéÅ –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É(-–∏) –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫(-–∏) –≤ –æ–¥–Ω–æ–º –∏–∑ —Ñ–æ—Ä–º–∞—Ç–æ–≤: https://... –∏–ª–∏ t.me/... –ù–∞–ø—Ä–∏–º–µ—Ä: t.me/nft/DurovsCap-1")

@dp.message(DealCreation.entering_description)
async def process_description(message: types.Message, state: FSMContext):
    description = message.text
    await state.update_data(description=description)
    
    data = await state.get_data()
    currency = data['currency']
    amount = data['amount']
    
    confirm_text = (
        f"{hbold('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏:')}\n\n"
        f"üí± –í–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[currency]}\n"
        f"üí∞ –°—É–º–º–∞: {amount}\n"
        f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n\n"
        f"–í—Å—ë –≤–µ—Ä–Ω–æ?"
    )
    
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data="confirm_deal")
    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")
    
    await state.set_state(DealCreation.confirming)
    await message.answer(
        confirm_text,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )

@dp.callback_query(lambda c: c.data == "confirm_deal", StateFilter(DealCreation.confirming))
async def confirm_deal(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    
    deal_id = db.create_deal(
        creator_id=callback.from_user.id,
        currency=data['currency'],
        amount=data['amount'],
        description=data['description']
    )
    
    await state.clear()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–¥–µ–ª–∫—É
    bot_username = (await callback.bot.me()).username
    clean_deal_id = deal_id.replace('#', '')
    deal_link = f"https://t.me/{bot_username}?start=deal_{clean_deal_id}"
    
    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø—Ä–æ–¥–∞–≤—Ü–∞
    req = db.get_requisites(callback.from_user.id)
    requisites_text = f"{hbold('üí≥ –í–∞—à–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã:')}\n"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å
    if req['card']:
        masked_card = f"**** **** **** {req['card'][-4:]}"
        requisites_text += f"üí≥ –ö–∞—Ä—Ç–∞: {masked_card}\n"
    if req['phone']:
        requisites_text += f"üì± –¢–µ–ª–µ—Ñ–æ–Ω (–°–ë–ü): +{req['phone']}\n"
    if req['stars']:
        requisites_text += f"‚≠ê STARS: @{req['stars']}\n"
    if req['ton_wallet']:
        masked_wallet = f"{req['ton_wallet'][:4]}...{req['ton_wallet'][-4:]}"
        requisites_text += f"üíé TON: {masked_wallet}\n"
    
    success_text = (
        f"{hbold('‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!')}\n\n"
        f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n"
        f"üí± –í–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[data['currency']]}\n"
        f"üí∞ –°—É–º–º–∞: {data['amount']}\n\n"
        f"{requisites_text}\n"
        f"–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:\n"
        f"{deal_link}\n\n"
        f"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å NFT –ø–æ–¥–¥–µ—Ä–∂–∫–µ."
    )
    
    await callback.message.edit_text(
        success_text,
        reply_markup=get_back_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith('pay_'))
async def process_pay(callback: types.CallbackQuery):
    deal_id = callback.data.replace('pay_', '')
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    if deal['status'] != DealStatus.PENDING.value:
        await callback.answer("‚ùå –≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã")
        return
    if deal['creator_id'] == callback.from_user.id:
        await callback.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–≤–æ—é —Å–¥–µ–ª–∫—É")
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É
    db.update_deal(deal_id,
                   buyer_id=callback.from_user.id,
                   status=DealStatus.PAID.value,
                   paid_at=datetime.now().isoformat())
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ
    buyer = db.get_user(callback.from_user.id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω" –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller_keyboard = InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text="üéÅ –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", callback_data=f"gift_sent_{deal_id}")
    ]])
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller_id = deal['creator_id']
    try:
        seller_notification = (
            f"{hbold('üí∞ –ü–æ–ª—É—á–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞ –ø–æ —Å–¥–µ–ª–∫–µ!')}\n\n"
            f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n"
            f"–°—É–º–º–∞: {deal['amount']} {SUPPORTED_CURRENCIES[deal['currency']]}\n\n"
            f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ:\n"
            f"üë§ –ò–º—è: {buyer['first_name']}\n"
            f"üìä –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {buyer['successful_deals']}\n"
            f"üí∞ –û–±–æ—Ä–æ—Ç: {buyer['total_turnover']} RUB\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ NFT –ø–æ–¥–¥–µ—Ä–∂–∫–µ @supporOTC\n"
            f"–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
        )
        await callback.bot.send_message(
            seller_id, 
            seller_notification, 
            reply_markup=seller_keyboard,
            parse_mode="HTML"
        )
    except Exception as e:
        logging.error(f"Failed to notify seller: {e}")
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    await callback.message.edit_text(
        f"{hbold('‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!')}\n\n"
        f"–ü—Ä–æ–¥–∞–≤–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ, –ø–æ–∫–∞ –æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–¥–∞—Ä–æ–∫ –≥–∞—Ä–∞–Ω—Ç—É.\n"
        f"–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.",
        reply_markup=get_back_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith('gift_sent_'))
async def process_gift_sent(callback: types.CallbackQuery):
    deal_id = callback.data.replace('gift_sent_', '')
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    if deal['creator_id'] != callback.from_user.id:
        await callback.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —ç—Ç–æ–π —Å–¥–µ–ª–∫–∏")
        return
    
    if deal['status'] != DealStatus.PAID.value:
        await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏")
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    db.update_deal(deal_id, 
                   status=DealStatus.NFT_SENT.value,
                   gift_sent_at=datetime.now().isoformat())
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    if deal['buyer_id']:
        try:
            await callback.bot.send_message(
                deal['buyer_id'],
                f"{hbold('üéÅ –ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–ø—Ä–∞–≤–∏–ª –ø–æ–¥–∞—Ä–æ–∫!')}\n\n"
                f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n"
                f"–ü—Ä–æ–¥–∞–≤–µ—Ü –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–µ—Ä–µ–¥–∞—á—É –ø–æ–¥–∞—Ä–∫–∞ –≥–∞—Ä–∞–Ω—Ç—É.\n"
                f"–û–∂–∏–¥–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏.",
                parse_mode="HTML"
            )
        except:
            pass
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
    await callback.message.edit_text(
        f"{hbold('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!')}\n\n"
        f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n"
        f"–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É –ø–æ–¥–∞—Ä–∫–∞.\n"
        f"–û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏.",
        reply_markup=get_back_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
    for admin_id in ADMIN_IDS.split(','):
        try:
            admin_id = int(admin_id.strip())
            await callback.bot.send_message(
                admin_id,
                f"{hbold('üéÅ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞!')}\n\n"
                f"–ü—Ä–æ–¥–∞–≤–µ—Ü –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ–¥–∞—Ä–∫–∞ –ø–æ —Å–¥–µ–ª–∫–µ {hcode(deal_id)}\n"
                f"–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏.",
                parse_mode="HTML"
            )
        except:
            pass

# –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats(callback: types.CallbackQuery):
    all_deals = db.get_all_deals()
    active_deals = db.get_active_deals()
    pending_deals = db.get_pending_deals()
    completed_deals = [d for d in all_deals if d['status'] == DealStatus.COMPLETED.value]
    
    total_turnover = sum(d['amount'] for d in completed_deals if d['currency'] == 'TON')
    total_users = len(db.users)
    
    stats_text = (
        f"{hbold('üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞')}\n\n"
        f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
        f"üì¶ –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {len(all_deals)}\n"
        f"üîÑ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {len(active_deals)}\n"
        f"‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã: {len(pending_deals)}\n"
        f"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–¥–µ–ª–æ–∫: {len(completed_deals)}\n"
        f"üí∞ –û–±—â–∏–π –æ–±–æ—Ä–æ—Ç (TON): {total_turnover}\n\n"
        f"–ü–æ –≤–∞–ª—é—Ç–∞–º:\n"
    )
    
    for currency in SUPPORTED_CURRENCIES:
        currency_deals = [d for d in completed_deals if d['currency'] == currency]
        currency_sum = sum(d['amount'] for d in currency_deals)
        stats_text += f"{SUPPORTED_CURRENCIES[currency]}: {currency_sum}\n"
    
    await callback.message.edit_text(stats_text, reply_markup=get_back_keyboard(), parse_mode="HTML")
    await callback.answer()

@dp.callback_query(lambda c: c.data == "admin_deals")
async def admin_deals_list(callback: types.CallbackQuery):
    active_deals = db.get_active_deals()
    
    if not active_deals:
        await callback.message.edit_text("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫", reply_markup=get_back_keyboard())
        await callback.answer()
        return
    
    text = f"{hbold('üìã –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏:')}\n\n"
    builder = InlineKeyboardBuilder()
    
    for deal in active_deals[:10]:
        status_emoji = {
            DealStatus.PENDING.value: "‚è≥",
            DealStatus.PAID.value: "üí∞",
            DealStatus.NFT_SENT.value: "üéÅ"
        }.get(deal['status'], "‚ùì")
        
        text += f"{status_emoji} {deal['deal_id']} - {deal['amount']} {deal['currency']}\n"
        builder.button(text=deal['deal_id'], callback_data=f"admin_deal_{deal['deal_id']}")
    
    builder.button(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_back")
    builder.adjust(3)
    
    await callback.message.edit_text(text, reply_markup=builder.as_markup(), parse_mode="HTML")
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("admin_deal_"))
async def admin_deal_detail(callback: types.CallbackQuery):
    deal_id = callback.data.replace("admin_deal_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.message.edit_text("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", reply_markup=get_back_keyboard())
        await callback.answer()
        return
    
    creator = db.get_user(deal['creator_id'])
    buyer = db.get_user(deal['buyer_id']) if deal['buyer_id'] else None
    
    deal_text = (
        f"{hbold(f'–°–¥–µ–ª–∫–∞ {deal_id}')}\n\n"
        f"–°—Ç–∞—Ç—É—Å: {deal['status']}\n"
        f"üí± –í–∞–ª—é—Ç–∞: {SUPPORTED_CURRENCIES[deal['currency']]}\n"
        f"üí∞ –°—É–º–º–∞: {deal['amount']}\n"
        f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {deal['description']}\n\n"
        f"üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: {creator['first_name']} (@{creator['username']})\n"
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞: {creator['successful_deals']} —Å–¥–µ–ª–æ–∫, {creator['total_turnover']} RUB\n"
    )
    
    if buyer:
        deal_text += f"\nüë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {buyer['first_name']} (@{buyer['username']})\n"
        deal_text += f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: {buyer['successful_deals']} —Å–¥–µ–ª–æ–∫, {buyer['total_turnover']} RUB\n"
    
    if deal['paid_at']:
        deal_text += f"\nüí∞ –û–ø–ª–∞—á–µ–Ω–æ: {deal['paid_at']}\n"
    if deal['gift_sent_at']:
        deal_text += f"üéÅ –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {deal['gift_sent_at']}\n"
    
    await callback.message.edit_text(
        deal_text,
        reply_markup=get_deal_actions_keyboard(deal_id, UserRole.ADMIN.value, callback.from_user.id),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("admin_complete_"))
async def admin_complete_deal(callback: types.CallbackQuery):
    deal_id = callback.data.replace("admin_complete_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    db.update_deal(deal_id, 
                   status=DealStatus.COMPLETED.value,
                   completed_at=datetime.now().isoformat())
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–¥–∞–≤—Ü–∞
    seller = db.get_user(deal['creator_id'])
    db.update_user(
        deal['creator_id'],
        successful_deals=seller['successful_deals'] + 1,
        total_turnover=seller['total_turnover'] + deal['amount']
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    if deal['buyer_id']:
        buyer = db.get_user(deal['buyer_id'])
        db.update_user(
            deal['buyer_id'],
            successful_deals=buyer['successful_deals'] + 1
        )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    for user_id in [deal['creator_id'], deal['buyer_id']]:
        if user_id:
            try:
                await bot.send_message(
                    user_id,
                    f"{hbold('‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!')}\n\n"
                    f"ID —Å–¥–µ–ª–∫–∏: {hcode(deal_id)}\n"
                    f"–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞!",
                    parse_mode="HTML"
                )
            except:
                pass
    
    await callback.message.edit_text(
        f"‚úÖ –°–¥–µ–ª–∫–∞ {deal_id} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
        reply_markup=get_admin_keyboard()
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "admin_add_turnover")
async def admin_add_turnover_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(AdminActions.adding_balance)
    await callback.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—É–º–º—É –æ–±–æ—Ä–æ—Ç–∞ –¥–ª—è –Ω–∞–∫—Ä—É—Ç–∫–∏ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ: ID –°–£–ú–ú–ê):\n"
        "–ü—Ä–∏–º–µ—Ä: 123456789 1000"
    )
    await callback.answer()

@dp.message(AdminActions.adding_balance)
async def admin_add_turnover_process(message: types.Message, state: FSMContext):
    try:
        parts = message.text.split()
        if len(parts) != 2:
            raise ValueError
            
        user_id = int(parts[0])
        amount = float(parts[1])
        
        user = db.get_user(user_id)
        db.update_user(user_id, total_turnover=user['total_turnover'] + amount)
        
        await message.answer(f"‚úÖ –û–±–æ—Ä–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ {amount}")
    except:
        await message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ID –°–£–ú–ú–ê")
    
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_add_success")
async def admin_add_success_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(AdminActions.adding_successful_deals)
    await callback.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –¥–ª—è –Ω–∞–∫—Ä—É—Ç–∫–∏ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ: ID –ö–û–õ–ò–ß–ï–°–¢–í–û):\n"
        "–ü—Ä–∏–º–µ—Ä: 123456789 5"
    )
    await callback.answer()

@dp.message(AdminActions.adding_successful_deals)
async def admin_add_success_process(message: types.Message, state: FSMContext):
    try:
        parts = message.text.split()
        if len(parts) != 2:
            raise ValueError
            
        user_id = int(parts[0])
        count = int(parts[1])
        
        user = db.get_user(user_id)
        db.update_user(user_id, successful_deals=user['successful_deals'] + count)
        
        await message.answer(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–≤–µ–ª–∏—á–µ–Ω—ã –Ω–∞ {count}")
    except:
        await message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ID –ö–û–õ–ò–ß–ï–°–¢–í–û")
    
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_users")
async def admin_users_list(callback: types.CallbackQuery):
    users_text = f"{hbold('üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:')}\n\n"
    
    for user_id, user_data in list(db.users.items())[:20]:
        users_text += f"ID: {user_id} | @{user_data['username']} | –°–¥–µ–ª–æ–∫: {user_data['successful_deals']} | –û–±–æ—Ä–æ—Ç: {user_data['total_turnover']}\n"
    
    await callback.message.edit_text(users_text, reply_markup=get_back_keyboard(), parse_mode="HTML")
    await callback.answer()

@dp.callback_query(lambda c: c.data == "admin_broadcast")
async def admin_broadcast_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(AdminActions.sending_broadcast)
    await callback.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:"
    )
    await callback.answer()

@dp.message(AdminActions.sending_broadcast)
async def admin_broadcast_process(message: types.Message, state: FSMContext):
    broadcast_text = message.text
    sent_count = 0
    failed_count = 0
    
    for user_id in db.users.keys():
        try:
            await bot.send_message(
                user_id,
                f"{hbold('üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏:')}\n\n{broadcast_text}",
                parse_mode="HTML"
            )
            sent_count += 1
            await asyncio.sleep(0.05)
        except:
            failed_count += 1
    
    await message.answer(
        f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n"
        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent_count}\n"
        f"–ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {failed_count}"
    )
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_back")
async def admin_back(callback: types.CallbackQuery):
    await callback.message.edit_text(
        f"{hbold('üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å')}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_admin_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "cancel")
async def cancel_action(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    user_id = callback.from_user.id
    await callback.message.edit_text(
        f"{hbold('üõ° Playerok Bot | OTC')}\n\n"
        f"{hbold('üëá –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:')}",
        reply_markup=get_main_keyboard(user_id),
        parse_mode="HTML"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("refresh_"))
async def refresh_deal(callback: types.CallbackQuery):
    deal_id = callback.data.replace("refresh_", "")
    deal = db.get_deal(deal_id)
    
    if not deal:
        await callback.answer("‚ùå –°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    user = db.get_user(callback.from_user.id)
    await callback.message.edit_reply_markup(
        reply_markup=get_deal_actions_keyboard(deal_id, user['role'], callback.from_user.id)
    )
    await callback.answer("üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã")

@dp.message()
async def handle_unknown(message: types.Message):
    user_id = message.from_user.id
    await message.answer(
        "‚ùå –Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:",
        reply_markup=get_main_keyboard(user_id)
    )

async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
